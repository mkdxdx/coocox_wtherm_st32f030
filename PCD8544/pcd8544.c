#include "stm32f0xx.h"
#include "stm32f0xx_rcc.h"
#include "stm32f0xx_gpio.h"
#include "stm32f0xx_spi.h"
#include "pcd8544.h"
#include "delay.h"


// 64*FONT_CHAR_WIDTH
#ifdef FONT_WIDE
const uint8_t font[] = {
	0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,	// space
	0b00000000,0b00000000,0b11011111,0b11011111,0b00000000,0b00000000,	// !
	0b00000000,0b00000011,0b00000000,0b00000011,0b00000000,0b00000000,	// "
	0b00100100,0b01111110,0b00100100,0b01111110,0b00100100,0b00000000,	// #
	0b00000000,0b01000110,0b10001001,0b11111111,0b10010001,0b01100010,	// $
	0b00000110,0b01000110,0b00110000,0b00001100,0b01100010,0b01100000,	// %
	0b01000000,0b10101100,0b10010010,0b01101010,0b01100100,0b10000000,	// &
	0b00000000,0b00000000,0b00000000,0b00000011,0b00000000,0b00000000,	// '
	0b00000000,0b00000000,0b01111110,0b10000001,0b00000000,0b00000000,	// (
	0b00000000,0b00000000,0b10000001,0b01111110,0b00000000,0b00000000,	// )
	0b01000010,0b00100100,0b11111111,0b00100100,0b01000010,0b00000000,	// *
	0b00001000,0b00001000,0b00111110,0b00001000,0b00001000,0b00000000,	// +
	0b00000000,0b11000000,0b01000000,0b00000000,0b00000000,0b00000000,	// ,
	0b00001000,0b00001000,0b00001000,0b00001000,0b00001000,0b00000000,	// -
	0b00000000,0b11000000,0b11000000,0b00000000,0b00000000,0b00000000,	// .
	0b00000000,0b01100000,0b00011000,0b00000110,0b00000000,0b00000000,	// /
	0b00111110,0b01000001,0b01000001,0b01000001,0b00111110,0b00000000,	// 0
	0b00000000,0b01000010,0b01111111,0b01000000,0b00000000,0b00000000,	// 1
	0b01000110,0b01100001,0b01010001,0b01001001,0b01000110,0b00000000,	// 2
	0b00100010,0b01000001,0b01001001,0b01001001,0b00110110,0b00000000,	// 3
	0b00001111,0b00001000,0b00001000,0b00001000,0b01111111,0b00000000,	// 4
	0b00100111,0b01000101,0b01000101,0b01000101,0b00111001,0b00000000,	// 5
	0b00111110,0b01001001,0b01001001,0b01001001,0b00110010,0b00000000,	// 6
	0b00000001,0b01000001,0b00110001,0b00001101,0b00000011,0b00000000,	// 7
	0b00110110,0b01001001,0b01001001,0b01001001,0b00110110,0b00000000,	// 8
	0b00000110,0b01001001,0b00101001,0b00011001,0b00001110,0b00000000,	// 9
	0b00000000,0b00110110,0b00110110,0b00000000,0b00000000,0b00000000,	// :
	0b00000000,0b00110110,0b00010110,0b00000000,0b00000000,0b00000000,	// ;
	0b00000000,0b00001000,0b00010100,0b00100010,0b00000000,0b00000000,	// <
	0b00010100,0b00010100,0b00010100,0b00010100,0b00000000,0b00000000,	// =
	0b00000000,0b00100010,0b00010100,0b00001000,0b00000000,0b00000000,	// >
	0b00000010,0b00000001,0b01010001,0b00001001,0b00000110,0b00000000,	// ?
	0b00111110,0b01011001,0b01100101,0b01011001,0b00101110,0b00000000,	// @
	0b01111100,0b00001010,0b00001001,0b00001001,0b01111111,0b00000000,	// a
	0b01111111,0b01001001,0b01001001,0b01001001,0b00110110,0b00000000,	// b
	0b00111110,0b01000001,0b01000001,0b01000001,0b00100010,0b00000000,	// c
	0b01111111,0b01000001,0b01000001,0b01000001,0b00111110,0b00000000,	// d
	0b01111111,0b01001001,0b01001001,0b01001001,0b01001001,0b00000000,	// e
	0b01111111,0b00001001,0b00001001,0b00001001,0b00001001,0b00000000,	// f
	0b00111110,0b01000001,0b01001001,0b01001001,0b00111010,0b00000000,	// g
	0b01111111,0b00001000,0b00001000,0b00001000,0b01111111,0b00000000,	// h
	0b00000000,0b01000001,0b01111111,0b01000001,0b00000000,0b00000000,	// i
	0b00100000,0b01000000,0b01000000,0b01000000,0b00111111,0b00000000,	// j
	0b01111111,0b00001000,0b00010100,0b00100010,0b01000001,0b00000000,	// k
	0b01111111,0b01000000,0b01000000,0b01000000,0b01000000,0b00000000,	// l
	0b01111111,0b00000010,0b00000100,0b00000010,0b01111111,0b00000000,	// m
	0b01111111,0b00000010,0b00000100,0b00001000,0b01111111,0b00000000,	// n
	0b00111110,0b01000001,0b01000001,0b01000001,0b00111110,0b00000000,	// o
	0b01111111,0b00001001,0b00001001,0b00001001,0b00000110,0b00000000,	// p
	0b00111110,0b01000001,0b01010001,0b01100001,0b00111110,0b00000000,	// q
	0b01111111,0b00011001,0b00101001,0b01001001,0b00000110,0b00000000,	// r
	0b00100110,0b01001001,0b01001001,0b01001001,0b00110010,0b00000000,	// s
	0b00000001,0b00000001,0b01111111,0b00000001,0b00000001,0b00000000,	// t
	0b00111111,0b01000000,0b01000000,0b01000000,0b00111111,0b00000000,	// u
	0b00011111,0b00100000,0b01000000,0b00100000,0b00011111,0b00000000,	// v
	0b00111111,0b01000000,0b00111111,0b01000000,0b00111111,0b00000000,	// w
	0b01110001,0b00001010,0b00000100,0b00001010,0b01110001,0b00000000,	// x
	0b00000111,0b01001000,0b01001000,0b01001000,0b00111111,0b00000000,	// y
	0b01100001,0b01010001,0b01001001,0b01000101,0b01000011,0b00000000,	// z
	0b00000000,0b01111111,0b01000001,0b01000001,0b00000000,0b00000000,	// [
	0b00000000,0b00000110,0b00011000,0b01100000,0b00000000,0b00000000,	// backslash
	0b00000000,0b01000001,0b01000001,0b01111111,0b00000000,0b00000000,	// ]
	0b00000100,0b00000010,0b00000001,0b00000010,0b00000100,0b00000000,	// ^
	0b10000000,0b10000000,0b10000000,0b10000000,0b10000000,0b10000000,	// _
	0b00000000,0b00000000,0b00000000,0b00000011,0b00000000,0b00000000,	// '
};
#else

#endif

// 10*48
const uint8_t digits[] = {
	0b10000000,0b11110000,0b11111000,0b01111100,0b00011110,0b00001110,
	0b00001110,0b00001110,0b00001110,0b00001110,0b00011110,0b01111100,
	0b11111000,0b11110000,0b10000000,0b00000000,0b11111111,0b11111111,
	0b11111111,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,
	0b00000000,0b00000000,0b00000000,0b00000000,0b11111111,0b11111111,
	0b11111111,0b00000000,0b00000001,0b00001111,0b00011111,0b00111110,
	0b01111000,0b01110000,0b01110000,0b01110000,0b01110000,0b01110000,
	0b01111000,0b00111110,0b00011111,0b00001111,0b00000001,0b00000000, // 0
	0b00000000,0b00000000,0b11000000,0b11000000,0b11100000,0b01110000,
	0b00111000,0b11111100,0b11111110,0b11111110,0b00000000,0b00000000,
	0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,
	0b00000001,0b00000000,0b00000000,0b00000000,0b00000000,0b11111111,
	0b11111111,0b11111111,0b00000000,0b00000000,0b00000000,0b00000000,
	0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,
	0b00000000,0b00000000,0b00000000,0b01111111,0b01111111,0b01111111,
	0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000, // 1
	0b01100000,0b01111000,0b01111100,0b00011100,0b00011110,0b00001110,
	0b00001110,0b00001110,0b00001110,0b00011110,0b00111100,0b11111100,
	0b11111000,0b11100000,0b00000000,0b00000000,0b00000000,0b00000000,
	0b00000000,0b00000000,0b00000000,0b10000000,0b11000000,0b11100000,
	0b11110000,0b01111000,0b00111100,0b00011111,0b00000111,0b00000011,
	0b00000000,0b00000000,0b01100000,0b01111000,0b01111100,0b01111110,
	0b01110111,0b01110011,0b01110001,0b01110000,0b01110000,0b01110000,
	0b01110000,0b01110000,0b01110000,0b01110000,0b00000000,0b00000000, // 2
	0b01100000,0b01110000,0b01111100,0b00111100,0b00011110,0b00001110,
	0b00001110,0b00001110,0b00001110,0b00001110,0b00011100,0b11111100,
	0b11111000,0b11110000,0b00000000,0b00000000,0b00000000,0b00000000,
	0b00000000,0b00000000,0b00000000,0b00000000,0b00001110,0b00001110,
	0b00001110,0b00001111,0b00011111,0b00111111,0b11111001,0b11111000,
	0b11100000,0b00000000,0b00000110,0b00011110,0b00111110,0b00111100,
	0b01111000,0b01110000,0b01110000,0b01110000,0b01110000,0b01110000,
	0b00111000,0b00111100,0b00011111,0b00001111,0b00000011,0b00000000, // 3
	0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,
	0b10000000,0b11100000,0b11110000,0b01111000,0b11111100,0b11111110,
	0b11111110,0b00000000,0b00000000,0b00000000,0b11000000,0b11100000,
	0b11110000,0b10111000,0b10011110,0b10001111,0b10000111,0b10000001,
	0b10000000,0b10000000,0b11111111,0b11111111,0b11111111,0b10000000,
	0b10000000,0b00000000,0b00000011,0b00000011,0b00000011,0b00000011,
	0b00000011,0b00000011,0b00000011,0b00000011,0b00000011,0b00000011,
	0b01111111,0b01111111,0b01111111,0b00000011,0b00000011,0b00000000, // 4
	0b00000000,0b11110000,0b11111110,0b11111110,0b00001110,0b00001110,
	0b00001110,0b00001110,0b00001110,0b00001110,0b00001110,0b00001110,
	0b00001110,0b00001110,0b00000000,0b00000000,0b00001110,0b00001111,
	0b00001111,0b00001101,0b00000110,0b00000111,0b00000111,0b00000111,
	0b00000111,0b00000111,0b00001111,0b00011110,0b11111100,0b11111000,
	0b11110000,0b00000000,0b00000110,0b00011110,0b00111110,0b00111100,
	0b01111000,0b01110000,0b01110000,0b01110000,0b01110000,0b01110000,
	0b00111000,0b00111100,0b00011111,0b00001111,0b00000011,0b00000000, // 5
	0b00000000,0b11100000,0b11111000,0b11111000,0b00111100,0b00011110,
	0b00001110,0b00001110,0b00001110,0b00001110,0b00011110,0b00111100,
	0b01111100,0b01111000,0b01100000,0b00000000,0b11111111,0b11111111,
	0b11111111,0b00111000,0b00011100,0b00001100,0b00001110,0b00001110,
	0b00001110,0b00001110,0b00011110,0b00111100,0b11111100,0b11111000,
	0b11100000,0b00000000,0b00000001,0b00001111,0b00011111,0b00111100,
	0b00111000,0b01110000,0b01110000,0b01110000,0b01110000,0b01110000,
	0b01111000,0b00111100,0b00011111,0b00001111,0b00000111,0b00000000, // 6
	0b00000000,0b00001110,0b00001110,0b00001110,0b00001110,0b00001110,
	0b00001110,0b00001110,0b00001110,0b10001110,0b11001110,0b11101110,
	0b01111110,0b00011110,0b00001110,0b00000000,0b00000000,0b00000000,
	0b00000000,0b00000000,0b00000000,0b10000000,0b11100000,0b11111000,
	0b01111110,0b00011111,0b00000011,0b00000001,0b00000000,0b00000000,
	0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,
	0b01111000,0b01111111,0b01111111,0b00000111,0b00000000,0b00000000,
	0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000, // 7
	0b00000000,0b11110000,0b11111000,0b11111100,0b00011110,0b00001110,
	0b00001110,0b00001110,0b00001110,0b00001110,0b00011100,0b11111100,
	0b11111000,0b11110000,0b00000000,0b00000000,0b11000000,0b11110000,
	0b11111001,0b00111011,0b00011111,0b00001110,0b00001110,0b00001110,
	0b00001110,0b00001110,0b00011111,0b00111011,0b11111001,0b11110000,
	0b11000000,0b00000000,0b00000111,0b00001111,0b00011111,0b00111100,
	0b01111000,0b01110000,0b01110000,0b01110000,0b01110000,0b01110000,
	0b01111000,0b00111100,0b00011111,0b00001111,0b00000111,0b00000000, // 8
	0b11100000,0b11110000,0b11111000,0b00111100,0b00011110,0b00001110,
	0b00001110,0b00001110,0b00001110,0b00001110,0b00011100,0b00111100,
	0b11111000,0b11110000,0b10000000,0b00000000,0b00000111,0b00011111,
	0b00111111,0b00111100,0b01111000,0b01110000,0b01110000,0b01110000,
	0b01110000,0b00110000,0b00111000,0b00011100,0b11111111,0b11111111,
	0b11111111,0b00000000,0b00000110,0b00011110,0b00111110,0b00111100,
	0b01111000,0b01110000,0b01110000,0b01110000,0b01110000,0b01111000,
	0b00111000,0b00011111,0b00011111,0b00000111,0b00000000,0b00000000,
};

//#define DCLK_LO		Display_PORT &= (~(1<<Display_CLK))
//#define DCLK_HI		Display_PORT |= (1<<Display_CLK)

//#define DDAT_LO		Display_PORT &= (~(1<<Display_DAT))
//#define DDAT_HI		Display_PORT |= (1<<Display_DAT)

#define DCE_LO		GPIO_ResetBits(Display_PORT,Display_CE)
#define DCE_HI		GPIO_SetBits(Display_PORT,Display_CE)

#define DRST_LO		GPIO_ResetBits(Display_PORT,Display_RST)
#define DRST_HI		GPIO_SetBits(Display_PORT,Display_RST)

#define DDC_LO		GPIO_ResetBits(Display_PORT,Display_DC)
#define DDC_HI		GPIO_SetBits(Display_PORT,Display_DC)


void Display_SetPort(void)
{
	// set port with pins and stuff
	GPIO_InitTypeDef gis;

	gis.GPIO_Pin = Display_DC | Display_RST | Display_CE;
	gis.GPIO_Speed = GPIO_Speed_Level_3;
	gis.GPIO_Mode = GPIO_Mode_OUT;
	gis.GPIO_OType = GPIO_OType_PP;
	GPIO_Init(Display_PORT, &gis);

	// set up spi: APB and AF on port

	RCC_APB2PeriphClockCmd(RCC_APB2Periph_SPI1, ENABLE);
	gis.GPIO_Pin = GPIO_Pin_5 | GPIO_Pin_7;
	gis.GPIO_Speed = GPIO_Speed_50MHz;
	gis.GPIO_PuPd = GPIO_PuPd_UP;
	gis.GPIO_Mode = GPIO_Mode_AF;
	gis.GPIO_OType = GPIO_OType_PP;
	GPIO_Init(Display_PORT, &gis);

	GPIO_PinAFConfig(Display_PORT,GPIO_PinSource7, GPIO_AF_0);
	GPIO_PinAFConfig(Display_PORT,GPIO_PinSource5, GPIO_AF_0);

	SPI_InitTypeDef spiis;
	spiis.SPI_BaudRatePrescaler = SPI_BaudRatePrescaler_32;
	spiis.SPI_NSS = SPI_NSS_Soft;
	spiis.SPI_FirstBit = SPI_FirstBit_MSB;
	spiis.SPI_Direction = SPI_Direction_1Line_Tx;
	spiis.SPI_CRCPolynomial = 7;
	spiis.SPI_CPOL = SPI_CPOL_Low;
	spiis.SPI_CPHA = SPI_CPHA_1Edge;
	spiis.SPI_DataSize = SPI_DataSize_8b;
	spiis.SPI_Mode = SPI_Mode_Master;
	SPI_Init(DisplaySPI,&spiis);
	SPI_Cmd(DisplaySPI,ENABLE);

}

void Display_Init(void)
{
	// set up our display port
	Display_SetPort();
	

	// reset pulse
	Display_Reset();

	// send some init commands
	DDC_LO;

	Display_Tx((uint8_t)0b00100001);
	// set VOP
	Display_Tx((uint8_t)0xB9);
	// set TCx
	Display_Tx((uint8_t)0x06);
	// set BSx
	Display_Tx((uint8_t)0b00010100);
	
	// set normal instruction set
	Display_Tx((uint8_t)0b00100000);
	
	// set normal mode
	Display_Tx((uint8_t)0b00001100);


}

void Display_Reset(void) {
	DRST_LO;
	delay_ms(200);
	DRST_HI;
}

void Display_SendData(uint8_t data)
{
	DDC_HI;
	Display_Tx(data);
}


void Display_SendCmd(uint8_t cmd)
{
	DDC_LO;
	Display_Tx(cmd);
}

void Display_Tx(uint8_t byte)
{
	DCE_LO;
	Display_TxF(byte);

	DCE_HI;
}

void Display_TxF(uint8_t byte) {
	while (SPI_I2S_GetFlagStatus(DisplaySPI, SPI_I2S_FLAG_TXE) == RESET) {}
	SPI_SendData8(DisplaySPI,byte);
	while (SPI_I2S_GetFlagStatus(DisplaySPI, SPI_I2S_FLAG_BSY) != RESET) {}
}

void Display_PutChar(char c)
	{
		if (c > 0) {
			uint8_t i;
			if (c>=0x61)
				c -= 32;

			c -= (char)' ';
			uint16_t start = c*FONT_CHAR_WIDTH;
			for (i = 0; i<FONT_CHAR_WIDTH; i++)
				Display_SendData(font[start+i]);
		}
	}






void Display_DigitVal(char *s, uint8_t x, uint8_t y)
{
	while(*s!='\0')	{
		Display_PutDigit(*s,x,y);
		x += DIGIT_BMP_WIDTH;
		s++;
	}
}


void Display_PutS(const char *s)
{
	while(*s!='\0')
	{
		Display_PutChar(*s);
		s++;
	}
}

void Display_Put(uint8_t data) {
	Display_SendData(data);
}



void Display_PutDigit(uint8_t n, uint8_t x, uint8_t y)
{
	if (n>9)
		n -= '0';
	uint8_t i;
	uint16_t seg = n*DIGIT_BMP_WIDTH*3;
	for (i = 0; i<3; i++)
	{
		uint8_t c;
		Display_SetXY(x,y+i);
		for (c = 0; c<DIGIT_BMP_WIDTH; c++)
		{
			Display_SendData(digits[seg]);
			seg++;
		}

	}
}



void Display_SetXY(uint8_t x, uint8_t y)
{
	Display_SendCmd(CMD_SETX+x);
	Display_SendCmd(CMD_SETY+y);
}

void Display_Clear(void)
{
	Display_SetXY(0,0);
	uint8_t iy,ix;
	for (iy = 0; iy<6; iy++)
		for (ix = 0; ix<84; ix++)
			Display_SendData(0);
	Display_SetXY(0,0);
}

#ifdef BUFFERED
void Display_Swap(void) {
	Display_SendCmd(CMD_SETX);
	Display_SendCmd(CMD_SETY);

	DCE_LO;
	DDC_HI;
	for (dcurx = 0; dcurx<Display_Length; dcurx++)
		Display_TxF(dbuf[dcurx]);
	DCE_HI;

	dcurx = 0;

	Display_SendCmd(CMD_SETX);
	Display_SendCmd(CMD_SETY);
}

void Display_PutAt(uint8_t data, uint8_t x, uint8_t y) {
	dbuf[Display_CalcP(x,y)] = data;
}

uint16_t Display_CalcP(uint8_t x, uint8_t y) {
	return (x+(y-1)*Display_Width);
}

uint8_t Display_Get() {
	return dbuf[dcurx];
}

uint8_t Display_GetAt(uint8_t x, uint8_t y) {
	return dbuf[Display_CalcP(x,y)];
}

void Display_SetCur(uint8_t x, uint8_t y) {
	dcurx = Display_CalcP(x,y);
}
#endif

